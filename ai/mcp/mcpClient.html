<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MCP Tools Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1 {
            color: #333;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #status, #logs {
            margin-top: 20px;
            padding: 10px;
            background-color: #eef;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            font-family: monospace;
        }

        #toolsList {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
        }

        ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<h1>üîå MCP Tools Viewer</h1>

<label for="sessionIdInput">Enter Session ID:</label>
<input type="text" id="sessionIdInput" placeholder="e.g. abc12345-6789-defg-0123" />

<button onclick="startInitialization()">Initialize MCP</button>
<button onclick="fetchToolsList()">Fetch Tools List</button>

<div id="status">‚è≥ Waiting for connection...</div>
<div id="toolsList"></div>
<div id="logs"></div>

<script>
    const statusElement = document.getElementById("status");
    const toolsListElement = document.getElementById("toolsList");
    const logsElement = document.getElementById("logs");

    let currentSessionId = null;
    let lastToolsCache = [];

    // ========== SSE ËøûÊé•ÂàùÂßãÂåñ ==========
    const sseSource = new EventSource('http://localhost:8088/sse');

    sseSource.onopen = () => {
        updateStatus("‚úÖ Successfully connected to MCP Server via SSE.");
    };

    sseSource.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            logMessage("üì® Received event:", data);

            if (data.type === 'INITIAL_TOOLS') {
                lastToolsCache = data.tools || [];
                displayTools(lastToolsCache);
            } else if (data.type === 'TOOLS_UPDATE') {
                lastToolsCache = data.tools || [];
                displayTools(lastToolsCache);
            }

        } catch (error) {
            logMessage("‚ö†Ô∏è Error parsing message:", error, "Raw:", event.data);
        }
    };

    sseSource.onerror = (error) => {
        logMessage("‚ùå SSE connection error:", error);
        updateStatus("üö´ Connection error. Please check the server.");
    };

    sseSource.onclose = () => {
        logMessage("üîå SSE connection closed.");
        updateStatus("üîå Connection to MCP Server closed.");
    };

    // ========== ËæÖÂä©ÂáΩÊï∞ ==========
    function updateStatus(msg) {
        statusElement.textContent = msg;
    }

    function logMessage(...args) {
        console.log(...args);
        logsElement.textContent += args.map(a => JSON.stringify(a, null, 2)).join(' ') + '\n\n';
    }

    function displayTools(tools) {
        if (!tools || tools.length === 0) {
            toolsListElement.innerHTML = '<p>üì¶ No tools available.</p>';
            return;
        }

        toolsListElement.innerHTML = '<h2>üõ† Available Tools:</h2><ul>';
        tools.forEach(tool => {
            toolsListElement.innerHTML += `<li><strong>${tool.name}</strong>: ${tool.description || 'No description'}</li>`;
        });
        toolsListElement.innerHTML += '</ul>';
    }

    // ========== JSON-RPC ËØ∑Ê±ÇÂáΩÊï∞ ==========
    async function sendRpcRequest(payload) {
        if (!currentSessionId) {
            alert("‚ö†Ô∏è No session ID set. Please initialize first.");
            return null;
        }

        const url = `http://localhost:8088/mcp/message?sessionId=${encodeURIComponent(currentSessionId)}`;
        logMessage("üì§ Sending request to", url, "Payload:", payload);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            // ‚úÖ Èò≤Ê≠¢Á©∫ÂìçÂ∫îÂØºËá¥Â¥©Ê∫É
            const text = await response.text();
            if (!text.trim()) {
                logMessage("üö´ Empty response received (no content returned)");
                return null;
            }

            // ‚úÖ ÂÆâÂÖ®Ëß£Êûê JSON
            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                logMessage("‚ö†Ô∏è Failed to parse JSON response:", e, "Raw text:", text);
                return null;
            }

            logMessage("üì• Response received:", result);
            return result;

        } catch (error) {
            logMessage("üö´ RPC request failed:", error);
            alert("Failed to send RPC request. Check logs.");
            return null;
        }
    }

    // ========== ÂàùÂßãÂåñÊåâÈíÆÈÄªËæë ==========
    function startInitialization() {
        const sessionId = document.getElementById("sessionIdInput").value.trim();
        if (!sessionId) {
            alert("‚ö†Ô∏è Please enter a valid Session ID.");
            return;
        }

        currentSessionId = sessionId;
        updateStatus("üîÑ Initializing MCP...");

        // Step 1: Initialize
        sendRpcRequest({
            jsonrpc: "2.0",
            method: "initialize",
            id: 1,
            params: {
                protocolVersion: "2024-11-05",
                clientInfo: {
                    name: "Web MCP Client",
                    version: "1.0"
                },
                capabilities: {}
            }
        }).then(() => {
            // Step 2: Send initialized notification
            return sendRpcRequest({
                jsonrpc: "2.0",
                method: "notifications/initialized"
            });
        }).then(() => {
            updateStatus("üéâ MCP Initialized successfully!");
        }).catch(err => {
            updateStatus("‚ùå Initialization failed.");
            logMessage("üí• Initialization error:", err);
        });
    }

    // ========== Ëé∑ÂèñÂ∑•ÂÖ∑ÂàóË°®ÊåâÈíÆÈÄªËæë ==========
    function fetchToolsList() {
        if (!currentSessionId) {
            alert("‚ö†Ô∏è Please initialize MCP first.");
            return;
        }

        updateStatus("üîç Fetching tools list...");

        sendRpcRequest({
		     id: 2,
            jsonrpc: "2.0",
            method: "tools/list",
			params: {
              yxtUserId: "1162325",

         }
        }).then(result => {
            if (result && result.result && Array.isArray(result.result)) {
                lastToolsCache = result.result;
                displayTools(result.result);
                updateStatus("‚úÖ Tools loaded from tools/list.");
            } else {
                logMessage("‚ö†Ô∏è Unexpected tools/list response format:", result);
                if (lastToolsCache.length > 0) {
                    displayTools(lastToolsCache);
                    updateStatus("üí° Fallback: Displaying cached tools from SSE.");
                } else {
                    toolsListElement.innerHTML = '<p>üö´ No tools found in response.</p>';
                    updateStatus("üö´ No tools returned from tools/list.");
                }
            }
        });
    }
</script>

</body>
</html>
